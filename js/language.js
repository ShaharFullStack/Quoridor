// --- LANGUAGE SYSTEM ---
let currentLanguage = 'he';

const translations = {
    en: {
        gameTitle: 'Quoridor 3D',
        gameDescription: 'Reach the other side before your opponent!',
        player1Walls: 'Player 1: {0} walls',
        player2Walls: 'Player 2: {0} walls',
        playerVsAI: 'Player vs AI: {0} walls',
        aiThinking: 'AI is thinking...',
        loadingModels: 'Loading models...',
        playerTurn: 'Player {0} turn',
        aiTurn: 'AI turn',
        chooseMove: 'Choose where to move',
        wallStep1: 'Step 1: Choose first wall segment (orange)',
        wallStep2: 'Step 2: Choose adjacent second wall segment (green)',
        winner: ' Player {0} wins! ',
        aiWinner: ' AI wins! ',
        playerWinner: ' You win! ',
        moveBtn: 'Move',
        wallBtn: 'Wall',
        wallStepBtn: 'Step {0}/2',
        cancelWallBtn: 'Cancel Wall',
        newGameBtn: 'New Game',
        pvpBtn: 'Player vs Player',
        pvcBtn: 'Player vs AI',
        pvpSubtitle: 'Play against a friend',
        pvcSubtitle: 'Challenge the computer',
        easyBtn: 'Easy',
        mediumBtn: 'Medium',
        hardBtn: 'Hard',
        easyDesc: 'Relaxed gameplay',
        mediumDesc: 'Balanced challenge',
        hardDesc: 'Expert level',
        gameModeTitle: 'Game Mode',
        difficultyTitle: 'Choose AI Difficulty',
        startGameBtn: 'Start Game',
        mobileHelp: 'Tap to move ‚Ä¢ Double-tap to switch modes',
        languageToggle: 'üåê ◊¢◊ë◊®◊ô◊™',
        restartBtn: 'Restart',
        undoBtn: 'Undo Move',
        soundBtn: 'Sound',
        themeBtn: 'Dark Mode',
        fullscreenBtn: 'Fullscreen',
        mainMenuBtn: 'Main Menu',
        playAgainBtn: 'Play Again',
        gameStatusTitle: 'Game Status',
        gameControlsTitle: 'Game Controls',
        settingsTitle: 'Settings',
        howToPlayTitle: 'How to Play'
    },
    he: {
        gameTitle: '◊ß◊ï◊®◊ô◊ì◊ï◊® ◊™◊ú◊™ ◊û◊ô◊û◊ì',
        gameDescription: '◊î◊í◊¢ ◊ú◊¶◊ì ◊î◊©◊†◊ô ◊ú◊§◊†◊ô ◊î◊ô◊®◊ô◊ë!',
        player1Walls: '◊©◊ó◊ß◊ü 1: {0} ◊ó◊ï◊û◊ï◊™',
        player2Walls: '◊©◊ó◊ß◊ü 2: {0} ◊ó◊ï◊û◊ï◊™',
        playerVsAI: '◊©◊ó◊ß◊ü ◊†◊í◊ì ◊û◊ó◊©◊ë: {0} ◊ó◊ï◊û◊ï◊™',
        aiThinking: '◊î◊û◊ó◊©◊ë ◊ó◊ï◊©◊ë...',
        loadingModels: '◊ò◊ï◊¢◊ü ◊ì◊û◊ï◊ô◊ï◊™...',
        playerTurn: '◊™◊ï◊® ◊©◊ó◊ß◊ü {0}',
        aiTurn: '◊™◊ï◊® ◊î◊û◊ó◊©◊ë',
        chooseMove: '◊ë◊ó◊® ◊ú◊ê◊ü ◊ú◊ñ◊ï◊ñ',
        wallStep1: '◊©◊ú◊ë 1: ◊ë◊ó◊® ◊û◊ô◊ß◊ï◊ù ◊ú◊ó◊ú◊ß ◊î◊®◊ê◊©◊ï◊ü ◊©◊ú ◊î◊ó◊ï◊û◊î (◊õ◊™◊ï◊ù)',
        wallStep2: '◊©◊ú◊ë 2: ◊ë◊ó◊® ◊û◊ô◊ß◊ï◊ù ◊°◊û◊ï◊ö ◊ú◊ó◊ú◊ß ◊î◊©◊†◊ô ◊©◊ú ◊î◊ó◊ï◊û◊î (◊ô◊®◊ï◊ß)',
        winner: ' ◊©◊ó◊ß◊ü {0} ◊†◊ô◊¶◊ó! ',
        aiWinner: ' ◊î◊û◊ó◊©◊ë ◊†◊ô◊¶◊ó! ',
        playerWinner: ' ◊†◊ô◊¶◊ó◊™! ',
        moveBtn: '◊™◊†◊ï◊¢◊î',
        wallBtn: '◊ó◊ï◊û◊î',
        wallStepBtn: '◊©◊ú◊ë {0}/2',
        cancelWallBtn: '◊ë◊ò◊ú ◊ó◊ï◊û◊î',
        newGameBtn: '◊û◊©◊ó◊ß ◊ó◊ì◊©',
        pvpBtn: '◊©◊ó◊ß◊ü ◊†◊í◊ì ◊©◊ó◊ß◊ü',
        pvcBtn: '◊©◊ó◊ß◊ü ◊†◊í◊ì ◊û◊ó◊©◊ë',
        pvpSubtitle: '◊©◊ó◊ß ◊†◊í◊ì ◊ó◊ë◊®',
        pvcSubtitle: '◊ê◊™◊í◊® ◊ê◊™ ◊î◊û◊ó◊©◊ë',
        easyBtn: '◊ß◊ú',
        mediumBtn: '◊ë◊ô◊†◊ï◊†◊ô',
        hardBtn: '◊ß◊©◊î',
        easyDesc: '◊û◊©◊ó◊ß ◊®◊í◊ï◊¢',
        mediumDesc: '◊ê◊™◊í◊® ◊û◊ê◊ï◊ñ◊ü',
        hardDesc: '◊®◊û◊™ ◊û◊ï◊û◊ó◊î',
        gameModeTitle: '◊û◊¶◊ë ◊û◊©◊ó◊ß',
        difficultyTitle: '◊ë◊ó◊® ◊®◊û◊™ ◊ß◊ï◊©◊ô',
        startGameBtn: '◊î◊™◊ó◊ú ◊û◊©◊ó◊ß',
        mobileHelp: '◊î◊ß◊© ◊õ◊ì◊ô ◊ú◊ñ◊ï◊ñ ‚Ä¢ ◊î◊ß◊© ◊§◊¢◊û◊ô◊ô◊ù ◊ú◊î◊ó◊ú◊§◊™ ◊û◊¶◊ë◊ô◊ù',
        languageToggle: 'üåê English',
        restartBtn: '◊î◊§◊¢◊ú ◊û◊ó◊ì◊©',
        undoBtn: '◊ë◊ò◊ú ◊û◊î◊ú◊ö',
        soundBtn: '◊¶◊ú◊ô◊ú',
        themeBtn: '◊û◊¶◊ë ◊õ◊î◊î',
        fullscreenBtn: '◊û◊°◊ö ◊û◊ú◊ê',
        mainMenuBtn: '◊™◊§◊®◊ô◊ò ◊®◊ê◊©◊ô',
        playAgainBtn: '◊©◊ó◊ß ◊©◊ï◊ë',
        gameStatusTitle: '◊û◊¶◊ë ◊î◊û◊©◊ó◊ß',
        gameControlsTitle: '◊§◊ß◊ì◊ô ◊û◊©◊ó◊ß',
        settingsTitle: '◊î◊í◊ì◊®◊ï◊™',
        howToPlayTitle: '◊ê◊ô◊ö ◊ú◊©◊ó◊ß'
    }
};

function t(key, ...args) {
    let text = translations[currentLanguage][key] || key;
    args.forEach((arg, index) => {
        text = text.replace(`{${index}}`, arg);
    });
    return text;
}

function switchLanguage() {
    currentLanguage = currentLanguage === 'en' ? 'he' : 'en';
    document.documentElement.lang = currentLanguage;
    document.body.classList.toggle('rtl', currentLanguage === 'he');
    updateAllText();
}

function updateAllText() {
    // Update starting screen
    const gameTitle = document.querySelector('.game-logo h1');
    if (gameTitle) gameTitle.textContent = t('gameTitle');
    
    const gameDesc = document.getElementById('game-description');
    if (gameDesc) gameDesc.textContent = t('gameDescription');
    
    // Update language toggle button (menu)
    const langToggle = document.getElementById('language-toggle');
    if (langToggle) {
        const langText = langToggle.querySelector('.btn-text') || langToggle.querySelector('span:last-child');
        if (langText) {
            langText.textContent = t('languageToggle').replace('üåê ', '');
        } else {
            langToggle.innerHTML = `<span>üåê</span> <span class="btn-text">${t('languageToggle').replace('üåê ', '')}</span>`;
        }
    }
    
    // Update starting screen language toggle
    const startLangToggle = document.getElementById('start-language-toggle');
    if (startLangToggle) {
        const startLangText = startLangToggle.querySelector('.btn-text');
        if (startLangText) {
            startLangText.textContent = t('languageToggle').replace('üåê ', '');
        }
    }
    
    // Update game mode selection texts
    const difficultyTitle = document.getElementById('difficulty-title');
    if (difficultyTitle) difficultyTitle.textContent = t('difficultyTitle');
    
    const pvpText = document.getElementById('pvp-btn-text');
    if (pvpText) pvpText.textContent = t('pvpBtn');
    
    const pvcText = document.getElementById('pvc-btn-text');
    if (pvcText) pvcText.textContent = t('pvcBtn');
    
    // Update starting screen subtitles
    const pvpSubtitle = document.getElementById('pvp-subtitle');
    if (pvpSubtitle) pvpSubtitle.textContent = t('pvpSubtitle');
    
    const pvcSubtitle = document.getElementById('pvc-subtitle');
    if (pvcSubtitle) pvcSubtitle.textContent = t('pvcSubtitle');
    
    const easyText = document.getElementById('easy-btn-text');
    if (easyText) easyText.textContent = t('easyBtn');
    
    const mediumText = document.getElementById('medium-btn-text');
    if (mediumText) mediumText.textContent = t('mediumBtn');
    
    const hardText = document.getElementById('hard-btn-text');
    if (hardText) hardText.textContent = t('hardBtn');
    
    // Update difficulty descriptions
    const easyDesc = document.getElementById('easy-desc');
    if (easyDesc) easyDesc.textContent = t('easyDesc');
    
    const mediumDesc = document.getElementById('medium-desc');
    if (mediumDesc) mediumDesc.textContent = t('mediumDesc');
    
    const hardDesc = document.getElementById('hard-desc');
    if (hardDesc) hardDesc.textContent = t('hardDesc');
    
    // Update main action button labels
    const moveBtnLabel = document.getElementById('move-btn-label');
    if (moveBtnLabel) moveBtnLabel.textContent = t('moveBtn');
    
    const wallBtnLabel = document.getElementById('wall-btn-label');
    if (wallBtnLabel) wallBtnLabel.textContent = t('wallBtn');
    
    // Update main language toggle button
    const mainLangToggle = document.querySelector('#main-language-toggle .btn-label');
    if (mainLangToggle) {
        mainLangToggle.textContent = t('languageToggle').replace('üåê ', '');
    }
    
    // Update menu button texts
    const resetBtnText = document.querySelector('#reset-btn .btn-text');
    if (resetBtnText) resetBtnText.textContent = t('newGameBtn');
    
    const restartBtnText = document.querySelector('#restart-btn .btn-text');
    if (restartBtnText) restartBtnText.textContent = t('restartBtn');
    
    const undoBtnText = document.querySelector('#undo-btn .btn-text');
    if (undoBtnText) undoBtnText.textContent = t('undoBtn');
    
    const soundBtnText = document.querySelector('#sound-toggle .btn-text');
    if (soundBtnText) soundBtnText.textContent = t('soundBtn');
    
    const themeBtnText = document.querySelector('#theme-toggle .btn-text');
    if (themeBtnText) themeBtnText.textContent = t('themeBtn');
    
    const fullscreenBtnText = document.querySelector('#fullscreen-btn .btn-text');
    if (fullscreenBtnText) fullscreenBtnText.textContent = t('fullscreenBtn');
    
    // Update winner overlay buttons
    const winnerMenuBtn = document.getElementById('winner-menu-btn');
    if (winnerMenuBtn) {
        winnerMenuBtn.innerHTML = `üè† ${t('mainMenuBtn')}`;
    }
    
    const winnerReplayBtn = document.getElementById('winner-replay-btn');
    if (winnerReplayBtn) {
        winnerReplayBtn.innerHTML = `üîÑ ${t('playAgainBtn')}`;
    }
    
    // FIXED: Re-setup winner overlay buttons after innerHTML changes using requestIdleCallback
    // to prevent layout shifts during button animations
    if (typeof setupWinnerOverlayButtons === 'function') {
        if (window.requestIdleCallback) {
            window.requestIdleCallback(() => {
                setupWinnerOverlayButtons();
            }, { timeout: 1000 });
        } else {
            setTimeout(setupWinnerOverlayButtons, 100);
        }
    }
    
    // Update menu section headers using translation keys
    const menuSections = document.querySelectorAll('.menu-section h3');
    if (menuSections.length >= 3) {
        menuSections[0].textContent = t('gameStatusTitle');
        menuSections[1].textContent = t('gameControlsTitle');
        menuSections[2].textContent = t('settingsTitle');
        if (menuSections[3]) {
            menuSections[3].textContent = t('howToPlayTitle');
        }
    }
    
    // Update game info section
    const gameInfoPs = document.querySelectorAll('.game-info p');
    if (gameInfoPs.length > 0 && currentLanguage === 'he') {
        gameInfoPs[0].innerHTML = ' <strong>◊û◊ò◊®◊î:</strong> ◊î◊í◊¢ ◊ú◊¶◊ì ◊î◊†◊í◊ì◊ô ◊©◊ú ◊î◊ú◊ï◊ó';
        gameInfoPs[1].innerHTML = ' <strong>◊™◊†◊ï◊¢◊î:</strong> ◊ú◊ó◊• ◊¢◊ú ◊î◊û◊®◊ë◊¢◊ô◊ù ◊î◊û◊°◊ï◊û◊†◊ô◊ù ◊õ◊ì◊ô ◊ú◊î◊ñ◊ô◊ñ ◊ê◊™ ◊î◊õ◊ú◊ô';
        gameInfoPs[2].innerHTML = ' <strong>◊ó◊ï◊û◊ï◊™:</strong> ◊î◊¶◊ë ◊ó◊ï◊û◊ï◊™ ◊õ◊ì◊ô ◊ú◊ó◊°◊ï◊ù ◊ê◊™ ◊†◊™◊ô◊ë ◊î◊ô◊®◊ô◊ë';
        gameInfoPs[3].innerHTML = ' <strong>◊ò◊ô◊§:</strong> ◊ê◊™◊î ◊ô◊õ◊ï◊ú ◊ú◊ß◊§◊ï◊• ◊û◊¢◊ú ◊î◊ô◊®◊ô◊ë!';
    } else if (gameInfoPs.length > 0) {
        gameInfoPs[0].innerHTML = ' <strong>Goal:</strong> Reach the opposite side of the board';
        gameInfoPs[1].innerHTML = ' <strong>Move:</strong> Click on highlighted squares to move your piece';
        gameInfoPs[2].innerHTML = ' <strong>Walls:</strong> Place walls to block your opponent\'s path';
        gameInfoPs[3].innerHTML = ' <strong>Tip:</strong> You can jump over your opponent!';
    }
    
    // Update mobile help text
    const mobileHelp = document.getElementById('mobile-help');
    if (mobileHelp) {
        mobileHelp.textContent = t('mobileHelp');
    }
    
    if (typeof updateUI === 'function') {
        updateUI(); // Refresh all dynamic text
    }
}

// Script loading complete
window.logTimer('Script js/language.js loaded', 'SCRIPT');